<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Gambit Accepted</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
            crossorigin="anonymous"></script>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="https://unpkg.com/intersection-observer"></script>
        <script src="https://unpkg.com/scrollama"></script>
        <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
            integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"
            integrity="sha512-xRllwz2gdZciIB+AkEbeq+gVhX8VB8XsfqeFbUh+SzHlN96dEduwtTuVuc2u9EROlmW9+yhRlxjif66ORpsgVA=="
            crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery.BgSwitcher/0.4.3/jquery.bgswitcher.min.js"
            integrity="sha512-cwDh42ooq48+o2kkbsn72Kwd9/Ghc34d48DFlNfOCRFJ1dM6EeIFs9d7PIBa4SSv6enwQAYmxsLZGgKOV0yE1A==" 
            crossorigin="anonymous"></script>
        <link rel="stylesheet"
            href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
            integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"
            crossorigin="anonymous">
        <link rel="stylesheet" href="https://use.typekit.net/irb2ijh.css">
        <style>
            * {
            box-sizing: border-box;
            }

            html,
            body {
            margin: 0;
            padding: 0;
            height: 100%;
            }

            main {
                height: 100%;
            }

            body {
            font-family: 'plantin';
            /* min-height: 1280px; */
            color: #3b3b3b;
            font-size: 12px;
            background-color: #D8CBC2;
            /* background: url('img/bg_1.jpg') no-repeat center center fixed;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover; */
            }

            p,
            h1,
            h2,
            h3,
            h4,
            a {
            margin: 0;
            font-weight: 400;
            }

            a,
            a:visited,
            a:hover {
            color: teal;
            text-decoration: none;
            border-bottom: 2px solid currentColor;
            }

            #videoOuter {
                position: fixed;
                width: 100%;
                height: 100%;
            }

            #videoInner {
                position: fixed;
                top: 0;
                bottom: 0;
                right: 0;
                left: 0;
                margin: auto;
                width: 100%;
                height: auto;
                opacity: 1;
            }

            #spacer {
                height: 100%;
                width: 100%;
            }

            #outro {
            height: 640px;
            }

            @media (min-width: 840px) {
            .nav__examples {
                margin-top: 0;
                margin-left: 2rem;
            }
            }
            #scrolly {
              position: relative;
              display: -webkit-box;
              display: -ms-flexbox;
              display: flex;
              padding: 1rem;
            }
      
            #scrolly > * {
              -webkit-box-flex: 1;
              -ms-flex: 1;
              flex: 1;
            }
      
            article {
              position: relative;
              padding: 0 1rem;
              max-width: 20rem;
            }
      
            figure {
              position: -webkit-sticky;
              position: sticky;
              width: 100%;
              margin: 0;
              -webkit-transform: translate3d(0, 0, 0);
              -moz-transform: translate3d(0, 0, 0);
              transform: translate3d(0, 0, 0);
              z-index: 0;
            }
      
            figure p {
              text-align: center;
              padding: 1rem;
              position: absolute;
              top: 50%;
              left: 50%;
              -moz-transform: translate(-50%, -50%);
              -webkit-transform: translate(-50%, -50%);
              transform: translate(-50%, -50%);
              font-size: 8rem;
              font-weight: 900;
              color: #fff;
            }
      
            .step {
                display: table;
                transition: opacity 0.2s ease-out;
                margin: 0 auto 2rem auto;
                color: #fff;
                opacity: 0.1;
            }
      
            .step:last-child {
              margin-bottom: 0;
            }
      
            .step.is-active {
              opacity: 1;
            }
      
            .step p {
                display: table-cell;
                text-align: left;
                padding: 1rem;
                font-size: 1rem;
                vertical-align: middle;
            }
          </style>
    </head>
    <body>
        <main>
        <div id='videoOuter'>
            <video autoplay muted loop id='videoInner'>
                <source src='img/queensgambit_video.mp4' type='video/mp4'>
            </video>
        </div>
        <div id='spacer'><span></span></div>
        <section id="scrolly">
            <article>
                <div class="step" data-step="1">
                    <p>"The Queen's Gambit", Netflix's 2020 surprise hit, set the record as the most-watched scripted limited series to date on the streaming platform. Within the first 28 days of the miniseries' release, 62 million member accounts had tuned in to watch the period coming-of-age drama.</p>
                </div>
                <div class="step" data-step="2">
                    <p>But what really made the success of the show surprising was not its genre, but rather its subject: the ancient game of chess.</p>
                </div>
                <div class="step" data-step="3">
                    <p>STEP 3</p>
                </div>
                <div class="step" data-step="4">
                    <p>STEP 4</p>
                </div>
            </article>
    
            <figure>
            </figure>
        </section>
        <section id="outro"><div id="myBoard" style="max-height: 100%; width: auto"></div></section>
        </main>
        <script>
            var main = d3.select("main")
            var board = Chessboard('myBoard', 'start')
            var scrolly = main.select("#scrolly")
            var figure = scrolly.select("figure")
            var article = scrolly.select("article")
            var step = article.selectAll(".step")
            var scroller = scrollama()
            var svg = null
            var margin = null
            var height = null
            var width = null

            // generic window resize listener event
            function handleResize() {
                // 1. update height of step elements
                var stepH = Math.floor(window.innerHeight * 0.75)
                step.style("height", stepH + "px")

                var figureHeight = window.innerHeight / 2
                var figureMarginTop = (window.innerHeight - stepH) / 2

                figure
                .style("height", stepH + "px")
                .style("top", figureMarginTop + "px")

                // 3. tell scrollama to update new element dimensions
                scroller.resize()
            }

            // scrollama event handlers
            function handleStepEnter(response) {
                console.log(response)
                // response = { element, direction, index }

                // add color to current step only
                step.classed("is-active", function(d, i) {
                return i === response.index
                });

                // update graphic based on step
                
            }

            function step1() {
                d3.csv('data/viewership.csv', function(data) {
                
                    var x = d3.scaleBand()
                        .range([ 0, width ])
                        .domain(data.map(function(d) { return d.Title; }))
                        .padding(0.2);
                    svg.append("g")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x))
                        .selectAll("text")
                            .attr("transform", "translate(-10,0)rotate(-45)")
                            .style("text-anchor", "end");

                    var y = d3.scaleLinear()
                        .domain([0, 90000000])
                        .range([ height, 0]);
                    svg.append("g")
                        .call(d3.axisLeft(y));

                    svg.selectAll("mybar")
                        .data(data)
                        .enter()
                        .append("rect")
                            .attr("x", function(d) { return x(d.Title); })
                            .attr("width", x.bandwidth())
                            .attr("fill", "#69b3a2")
                            // no bar at the beginning thus:
                            .attr("height", function(d) { return height - y(0); }) // always equal to 0
                            .attr("y", function(d) { return y(0); })

                    svg.selectAll("rect")
                        .transition()
                        .duration(800)
                        .attr("y", function(d) { return y(d.Viewership); })
                        .attr("height", function(d) { return height - y(d.Viewership); })
                        .delay(function(d,i){console.log(i) ; return(i*100)})
                })
            }

            function setupStickyfill() {
                d3.selectAll(".sticky").each(function() {
                Stickyfill.add(this)
                })
            }

            function init() {
                setupStickyfill()

                // 1. force a resize on load to ensure proper dimensions are sent to scrollama
                handleResize()

                // 2. setup the scroller passing options
                // 		this will also initialize trigger observations
                // 3. bind scrollama event handlers (this can be chained like below)
                scroller
                .setup({
                    step: "#scrolly article .step",
                    offset: 0.33,
                    debug: false
                })
                .onStepEnter(handleStepEnter)

                // setup resize event
                window.addEventListener("resize", handleResize)

                margin = {top: 30, right: 30, bottom: 90, left: 90}
                width =  $('figure').width() - margin.left - margin.right
                height = $('figure').height() - margin.top - margin.bottom

                svg = figure.append("svg")//selecting on basis of ID.
                    .attr("width", (width + margin.left + margin.right))
                    .attr("height", (height + margin.top + margin.bottom))
                    .append('g')
                    .attr('transform', "translate(" + margin.left + "," + margin.top + ")")

                step1()
            }

            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms))
            }
            
            async function queensGambit () {
                board.move('d2-d4')
                await sleep(1200)
                board.move('d7-d5')
                await sleep(1200)
                board.move('c2-c4')
                await sleep(1200)
                board.start()
                window.setTimeout(queensGambit, 1200)
            }

            window.setTimeout(queensGambit, 500)

            // kick things off
            init()

            $(window).scroll(function() {
                $('#videoInner').css('opacity', 1 - $(window).scrollTop() / ( $('#videoOuter').height() / 2))
            })
        </script>
    </body>
</html>